name: WASM Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        targets: wasm32-unknown-unknown

    - name: Install wasm-pack
      run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

    - name: Install Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Build server
      run: cargo build

    - name: Build WASM package
      run: |
        cd ./pkarr
        chmod +x build-wasm.sh
        ./build-wasm.sh

    - name: Start server and run all tests
      run: |
        # Start the server binary in the background
        echo "🚀 Starting pkarr-relay in testnet mode..."
        ./target/debug/pkarr-relay --testnet &
        SERVER_PID=$!
        
        # Wait for server to start and check if it's running
        echo "⏳ Waiting for server to start..."
        sleep 20
        
        # # Verify server is actually ready by testing the API
        # echo "🧪 Testing server API readiness..."
        # SERVER_READY=false
        # for i in {1..15}; do
        #     # Test the health/info endpoint (should return some response)
        #     if curl -s -f http://localhost:15411/ >/dev/null 2>&1; then
        #         echo "✅ Server API is responding correctly"
        #         SERVER_READY=true
        #         break
        #     elif curl -s http://localhost:15411/ 2>&1 | grep -q "404\|405\|200"; then
        #         # Even if it's 404/405, it means server is responding
        #         echo "✅ Server is responding (got HTTP response)"
        #         SERVER_READY=true
        #         break
        #     fi
        #     echo "   Attempt $i/15: API not ready yet, waiting..."
        #     sleep 2
        # done
        
        # # Final check - ensure server is truly ready
        # if [ "$SERVER_READY" = false ]; then
        #     echo "❌ Server failed to become ready after 30 seconds"
        #     echo "🔍 Server process status:"
        #     ps aux | grep pkarr-relay || echo "   No pkarr-relay process found"
        #     echo "🔍 Network connections:"
        #     netstat -tlnp | grep :15411 || echo "   No process listening on port 15411"
        #     echo "🔍 Server logs (if any):"
        #     # Try to get some server output
        #     kill $SERVER_PID
        #     exit 1
        # fi
        
        # # Change the working directory to pkarr crate
        # cd ./pkarr
        
        # # Run wasm-pack tests (Rust WASM tests)
        # echo "🦀 Running Rust WASM tests..."
        # wasm-pack test --headless --firefox --lib
        
        # # Change to the pkg directory and run JavaScript tests
        echo "🟨 Running JavaScript tests..."
        cd pkarr/pkg
        npm run test

        # Ensure server gets killed on exit
        kill $SERVER_PID
        
        echo "✅ All tests completed successfully!"